# Cerberus AI Code Review Council
# https://github.com/misty-step/cerberus
name: Cerberus Council

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: cerberus-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: "${{ matrix.reviewer }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - reviewer: APOLLO
            perspective: correctness
            model: openrouter/qwen/qwen3.5-plus-02-15
            fallbackModel: openrouter/anthropic/claude-sonnet-4.6
          - reviewer: ATHENA
            perspective: architecture
            model: openrouter/qwen/qwen3.5-plus-02-15
            fallbackModel: openrouter/anthropic/claude-sonnet-4.6
          - reviewer: SENTINEL
            perspective: security
            model: openrouter/qwen/qwen3.5-plus-02-15
            fallbackModel: openrouter/anthropic/claude-sonnet-4.6
          - reviewer: VULCAN
            perspective: performance
            model: openrouter/qwen/qwen3.5-plus-02-15
            fallbackModel: openrouter/anthropic/claude-sonnet-4.6
          - reviewer: ARTEMIS
            perspective: maintainability
            model: openrouter/qwen/qwen3.5-plus-02-15
            fallbackModel: openrouter/anthropic/claude-sonnet-4.6
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Cerberus review (primary)
        id: cerberus_primary
        continue-on-error: true
        uses: misty-step/cerberus@v1
        with:
          perspective: ${{ matrix.perspective }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: ${{ matrix.model }}
          timeout: "1200"

      - name: Decide fallback rerun
        id: cerberus_fallback_decision
        if: always()
        shell: bash
        run: |
          verdict="${{ steps.cerberus_primary.outputs.verdict }}"
          verdict_json="${{ steps.cerberus_primary.outputs.verdict-json }}"

          if [[ -z "$verdict" || -z "$verdict_json" || ! -f "$verdict_json" ]]; then
            echo "rerun=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          confidence="$(jq -r '.confidence // 0' "$verdict_json")"
          summary="$(jq -r '.summary // ""' "$verdict_json")"

          if [[ "$verdict" == "SKIP" ]]; then
            echo "rerun=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$verdict" == "FAIL" ]] && [[ "$confidence" == "0" || "$confidence" == "0.0" ]] && [[ "$summary" == Review\ output\ could\ not\ be\ parsed* ]]; then
            echo "rerun=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "rerun=false" >> "$GITHUB_OUTPUT"

      - name: Cerberus review (fallback)
        id: cerberus_fallback
        if: steps.cerberus_fallback_decision.outputs.rerun == 'true'
        continue-on-error: true
        uses: misty-step/cerberus@v1
        with:
          perspective: ${{ matrix.perspective }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: ${{ matrix.fallbackModel }}
          timeout: "1200"

      - name: Enforce verdict
        if: always()
        shell: bash
        run: |
          verdict="${{ steps.cerberus_primary.outputs.verdict }}"
          verdict_json="${{ steps.cerberus_primary.outputs.verdict-json }}"

          if [[ "${{ steps.cerberus_fallback_decision.outputs.rerun }}" == "true" ]]; then
            verdict="${{ steps.cerberus_fallback.outputs.verdict }}"
            verdict_json="${{ steps.cerberus_fallback.outputs.verdict-json }}"
          fi

          if [[ -z "$verdict" || -z "$verdict_json" || ! -f "$verdict_json" ]]; then
            echo "::error::Cerberus ${{ matrix.perspective }} produced no verdict output."
            exit 1
          fi

          confidence="$(jq -r '.confidence // 0' "$verdict_json")"
          summary="$(jq -r '.summary // ""' "$verdict_json")"

          if [[ "$verdict" == "SKIP" ]]; then
            echo "::error::Cerberus ${{ matrix.perspective }} skipped (timeout/API error): $summary"
            exit 1
          fi

          if [[ "$verdict" != "FAIL" ]]; then
            exit 0
          fi

          if [[ "$confidence" == "0" || "$confidence" == "0.0" ]] && [[ "$summary" == Review\ output\ could\ not\ be\ parsed* ]]; then
            echo "::error::Cerberus ${{ matrix.perspective }} output could not be parsed: $summary"
            exit 1
          fi

          echo "::error::Cerberus ${{ matrix.perspective }} verdict: FAIL"
          exit 1

  verdict:
    name: "Council Verdict"
    needs: review
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: misty-step/cerberus/verdict@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
