# ADR-0004: AI Report Versioning (Markdown v1 vs Structured v2)

Date: 2026-01-13
Status: accepted

## Context and Problem Statement

The AI workout reports started as free-form markdown generated by GPT. This worked initially but created problems:
- Inconsistent formatting across reports
- Difficult to render consistently in UI
- Hard to extract specific data points (PRs, metrics) programmatically
- AI hallucination risk for numeric values

The system needed to evolve while preserving existing reports.

## Considered Options

### Option 1: Migrate all reports to new format (not chosen)

- Pros: Clean database; single rendering path.
- Cons: Destructive; loses original AI voice; complex migration; risk of data loss.

### Option 2: Version field with parallel renderers (chosen)

- Pros: Preserves history; gradual rollout; fallback to v1 if v2 has issues.
- Cons: Dual rendering code; schema complexity; frontend must handle both.

### Option 3: New table for v2 reports (not chosen)

- Pros: Clean separation; no schema migration.
- Cons: Query complexity (UNION-like behavior); duplicate indexes; harder history view.

## Decision Outcome

**Chosen**: Option 2 â€” Single `aiReports` table with `reportVersion` field and dual content storage.

### Schema Design

```typescript
aiReports: {
  // V1: Markdown content (legacy)
  content: v.optional(v.string()),

  // V2: Structured JSON content
  structuredContent: v.optional(v.any()),

  // Version for renderer selection
  // undefined or "1.0": Legacy markdown (uses content)
  // "2.0": Structured JSON (uses structuredContent)
  reportVersion: v.optional(v.string()),
}
```

### V2 Architecture: Hybrid Compute + AI

The key insight driving v2: **AI should generate creative content, not compute metrics**.

V2 splits responsibilities:
1. **Server computes**: Period dates, volume totals, PR history, streaks (reliable data)
2. **AI generates**: Celebration copy, motivational headlines, action directives (creative content)

This eliminates AI hallucination for numbers while preserving the personalized voice.

### Structured Content Schema (V2)

```typescript
interface AIReportV2 {
  version: "2.0";
  period: { type, startDate, endDate, label };
  metrics: { volume, workouts, streak };
  pr: { hasPR, exercise?, value?, headline?, celebrationCopy? };
  action: { directive, explanation };
}
```

### Consequences

**Good**
- Old reports remain valid indefinitely
- New reports have predictable structure for UI components
- AI cost reduced (smaller prompts, focused on creative tasks)
- Numeric accuracy guaranteed (computed, not generated)

**Bad**
- Frontend must handle both v1 and v2 rendering paths
- `structuredContent: v.any()` loses type safety in schema (validated at runtime)

**Neutral**
- Can add v3 in future with same pattern
- Old reports naturally age out of "recent" views

## Implementation Notes

- V1 generator: `convex/ai/generate.ts` (deprecated, still works)
- V2 generator: `convex/ai/generateV2.ts` (current default)
- Schema types: `convex/ai/reportV2Schema.ts`
- Renderer selection: Check `reportVersion` field, fallback to v1 if missing

## References

- convex/schema.ts (aiReports table)
- convex/ai/generateV2.ts (V2 generation)
- convex/ai/reportV2Schema.ts (structured types)
