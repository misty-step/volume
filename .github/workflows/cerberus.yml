# Cerberus AI Code Review Council
# https://github.com/misty-step/cerberus
name: Cerberus Council

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: cerberus-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: "${{ matrix.reviewer }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - reviewer: APOLLO
            perspective: correctness
            model: openrouter/moonshotai/kimi-k2.5
            fallbackModel: openrouter/minimax/minimax-m2.5
          - reviewer: ATHENA
            perspective: architecture
            model: openrouter/moonshotai/kimi-k2.5
            fallbackModel: openrouter/minimax/minimax-m2.5
          - reviewer: SENTINEL
            perspective: security
            model: openrouter/moonshotai/kimi-k2.5
            fallbackModel: openrouter/minimax/minimax-m2.5
          - reviewer: VULCAN
            perspective: performance
            model: openrouter/moonshotai/kimi-k2.5
            fallbackModel: openrouter/minimax/minimax-m2.5
          - reviewer: ARTEMIS
            perspective: maintainability
            model: openrouter/moonshotai/kimi-k2.5
            fallbackModel: openrouter/minimax/minimax-m2.5
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Cerberus review (primary)
        id: cerberus_primary
        continue-on-error: true
        uses: misty-step/cerberus@v1
        with:
          perspective: ${{ matrix.perspective }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: ${{ matrix.model }}

      - name: Decide fallback rerun
        id: cerberus_fallback_decision
        if: always()
        shell: bash
        run: |
          verdict="${{ steps.cerberus_primary.outputs.verdict }}"
          verdict_json="${{ steps.cerberus_primary.outputs.verdict-json }}"

          if [[ -z "$verdict" || -z "$verdict_json" || ! -f "$verdict_json" ]]; then
            echo "rerun=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          confidence="$(jq -r '.confidence // 0' "$verdict_json")"
          summary="$(jq -r '.summary // ""' "$verdict_json")"

          if [[ "$verdict" == "FAIL" ]] && [[ "$confidence" == "0" || "$confidence" == "0.0" ]] && [[ "$summary" == Review\ output\ could\ not\ be\ parsed* ]]; then
            echo "rerun=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "rerun=false" >> "$GITHUB_OUTPUT"

      - name: Cerberus review (fallback)
        id: cerberus_fallback
        if: steps.cerberus_fallback_decision.outputs.rerun == 'true'
        continue-on-error: true
        uses: misty-step/cerberus@v1
        with:
          perspective: ${{ matrix.perspective }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: ${{ matrix.fallbackModel }}

      - name: Enforce verdict
        if: always()
        shell: bash
        run: |
          verdict="${{ steps.cerberus_primary.outputs.verdict }}"
          verdict_json="${{ steps.cerberus_primary.outputs.verdict-json }}"

          if [[ "${{ steps.cerberus_fallback_decision.outputs.rerun }}" == "true" ]]; then
            verdict="${{ steps.cerberus_fallback.outputs.verdict }}"
            verdict_json="${{ steps.cerberus_fallback.outputs.verdict-json }}"
          fi

          if [[ -z "$verdict" || -z "$verdict_json" || ! -f "$verdict_json" ]]; then
            echo "::warning::Cerberus ${{ matrix.perspective }} produced no verdict output. Skipping enforcement."
            exit 0
          fi

          confidence="$(jq -r '.confidence // 0' "$verdict_json")"
          summary="$(jq -r '.summary // ""' "$verdict_json")"

          if [[ "$verdict" != "FAIL" ]]; then
            exit 0
          fi

          if [[ "$confidence" == "0" || "$confidence" == "0.0" ]] && [[ "$summary" == Review\ output\ could\ not\ be\ parsed* ]]; then
            echo "::warning::Cerberus ${{ matrix.perspective }} output could not be parsed; treating as SKIP to avoid flaky CI."
            exit 0
          fi

          echo "::error::Cerberus ${{ matrix.perspective }} verdict: FAIL"
          exit 1

  verdict:
    name: "Council Verdict"
    needs: review
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: misty-step/cerberus/verdict@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Avoid blocking PRs on model/format flakiness (e.g. no ```json block found).
          # Per-reviewer jobs still hard-fail on real FAIL verdicts.
          fail-on-verdict: "false"

      - name: Enforce council verdict (ignore parse failures)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          verdict_files="$(find ./verdicts -type f -name '*-verdict.json' 2>/dev/null || true)"
          if [[ -z "$verdict_files" ]]; then
            echo "::warning::No Cerberus verdict artifacts found. Skipping enforcement."
            exit 0
          fi

          failed=0
          for f in $verdict_files; do
            verdict="$(jq -r '.verdict // ""' "$f")"
            confidence="$(jq -r '.confidence // 0' "$f")"
            summary="$(jq -r '.summary // ""' "$f")"
            reviewer="$(jq -r '.reviewer // "unknown"' "$f")"
            perspective="$(jq -r '.perspective // "unknown"' "$f")"

            if [[ "$verdict" != "FAIL" ]]; then
              continue
            fi

            if [[ "$confidence" == "0" || "$confidence" == "0.0" ]] && [[ "$summary" == Review\ output\ could\ not\ be\ parsed* ]]; then
              echo "::warning::Cerberus $reviewer ($perspective) output could not be parsed; treating as SKIP to avoid flaky CI."
              continue
            fi

            echo "::error::Cerberus $reviewer ($perspective) verdict: FAIL"
            echo "::error::Summary: $summary"
            failed=1
          done

          if [[ "$failed" -ne 0 ]]; then
            exit 1
          fi
